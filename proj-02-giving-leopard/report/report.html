<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Giving-leopard">

<title>NBA Data Analysis Report</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="report_files/libs/clipboard/clipboard.min.js"></script>
<script src="report_files/libs/quarto-html/quarto.js"></script>
<script src="report_files/libs/quarto-html/popper.min.js"></script>
<script src="report_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="report_files/libs/quarto-html/anchor.min.js"></script>
<link href="report_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="report_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="report_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="report_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="report_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">NBA Data Analysis Report</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Giving-leopard </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>In modern professional sports, the importance of data analysis is increasingly prominent. With the advancement of technology, data-driven decision-making is now an indispensable part of major sports organizations. Among them, the NBA stands out due to its complex salary system, diverse player roles and changeable tactical evolution, which gives rise to many data sets worthy of analysis.</p>
<p>This project aims to build an interactive web platform using the R language, conduct visual analysis and data exploration on the performance of NBA players using public NBA data, and explore several factors related to salary. We focus on the following core issues:</p>
<ol type="1">
<li>Is the effort value of the players reasonably reflected by their salaries?</li>
<li>Is Is there a connection between defensive ability and career lifespan?</li>
<li>How can traditional centers complete their transformation in the “small-ball era”?</li>
<li>Do high-utilization players truly demonstrate the salary returns they deserve?</li>
</ol>
<p>These issues are related to multiple stakeholders. For example, the team management seeks to optimize the budget, players hope to receive fair compensation, and fans are increasingly concerned about the performance of players. Our analysis provides evidence-based insights to help improve the player performance evaluation system and also offers data support for the team’s salary management and cost control.</p>
</section>
<section id="question-1-is-the-effort-value-of-the-players-reasonably-reflected-by-their-salaries" class="level2">
<h2 class="anchored" data-anchor-id="question-1-is-the-effort-value-of-the-players-reasonably-reflected-by-their-salaries">Question 1: Is the effort value of the players reasonably reflected by their salaries?</h2>
<section id="justification-of-approach" class="level3">
<h3 class="anchored" data-anchor-id="justification-of-approach">Justification of approach</h3>
</section>
<section id="the-relationship-between-hustle-stat-and-salary" class="level3">
<h3 class="anchored" data-anchor-id="the-relationship-between-hustle-stat-and-salary">The Relationship Between Hustle Stat and Salary</h3>
<p><img src="pic/Q1/Hustle-vs-Salary.png" class="img-fluid" alt="Hustle Stat (Pct Steals) vs Salary"> First, we selected Pct Steals as a proxy for hustle due to its availability and interpretability, and chose Minutes Played and Salary as objective indicators of player value and team investment. Hence, we took Pct Steals as the horizontal axis, Salary as the vertical axis, and colored it with Minutes Played to explore the direct correlation between hustle stat and salary. In the graph, we notice that some players with high effort values have relatively low salaries, while the effort values of some high-salary players are at a medium to low level. This indicates that the effort level of players is not always proportional to their salaries, and there is a certain unreasonable phenomenon.</p>
<p><img src="pic/Q1/Hustle-vs%20MinutesPlayed.png" class="img-fluid" alt="Hustle Stat vs Minutes Played"> Next, we plotted a scatter plot of Pct Steals and Minutes Played to observe their relationship, but this time using salary as the color mapping. This chart reveals that in most cases, players with higher effort values do have more playing time, but high effort does not always lead to high salaries.</p>
<p><img src="pic/Q1/MinutesPlayedbyHustleQuartile.png" class="img-fluid" alt="Minutes Played by Hustle Quartile"> To better compare the differences among groups, we divided all the players into four Hustle Quartiles according to their effort values and plotted the box plots of their playing time respectively. This design helps us identify whether there is systemic injustice in the distribution of treatment at different levels of effort. We originally intended to plot the box plot with Salary, but because there are too many extreme values, using Minutes Played as the metric can provide a more stable analysis perspective.</p>
</section>
<section id="limitation" class="level3">
<h3 class="anchored" data-anchor-id="limitation">Limitation</h3>
<p>Although the analytical design structure is clear, there are still some limitations and hypothetical risks in this part. First, the metric dimension of hustle stat is relatively narrow. In this project, Pct Steals is used as the representative variable of “hustle stat”, but in reality, efforts also include blocking, rushing, helping to defend and many other behaviors. Due to the limitation of data dimensions, we failed to comprehensively construct a multi-index effort composite index. In addition, there is also the externality of the salary system. NBA salaries are not only determined by players’ performance, but also subject to factors such as the year of contract signing, salary cap structure, and market factors. In addition, data integrity and extreme value processing also have an impact on visualization. Very few players’ data have cases where hustle stat = 0 or salary = 0. We retain these data to keep the full information, but this might pull down the overall trend. Therefore, our current analysis emphasizes general patterns over extreme cases. In future modeling, special processing is required for this type of outliers.</p>
</section>
</section>
<section id="question-2-is-is-there-a-connection-between-defensive-ability-and-career-lifespan" class="level2">
<h2 class="anchored" data-anchor-id="question-2-is-is-there-a-connection-between-defensive-ability-and-career-lifespan">Question 2: Is Is there a connection between defensive ability and career lifespan?</h2>
<section id="justification-of-approach-1" class="level3">
<h3 class="anchored" data-anchor-id="justification-of-approach-1">Justification of approach</h3>
</section>
<section id="the-relationship-between-defensive-ability-and-career-lifespan." class="level3">
<h3 class="anchored" data-anchor-id="the-relationship-between-defensive-ability-and-career-lifespan.">The Relationship Between Defensive Ability and Career Lifespan.</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="pic/Q2/Defensive%20Rating%20vs%20Career%20Length.png" class="img-fluid figure-img"></p>
<figcaption>Defensive Rating vs Career Length</figcaption>
</figure>
</div>
<p>To explore the potential connection between defensive ability and player lifespan, we use defensive grade as a proxy for defensive performance. Defensive grade is a recognized indicator for measuring a player’s contribution to the team’s defense. The lower the defensive grade, the better the defensive performance.</p>
<p>The first scatterplot, Defensive Rating vs Career Length, plots each player’s best single-season defensive rating against their total number of NBA seasons played. This visualization reveals that while there is a large spread in defensive rating among players with short careers, those who have enjoyed the longest tenures—often more than a decade in the league—tend to have achieved strong defensive ratings at some point in their careers. However, not all long-career players were elite defenders</p>
<p><img src="pic/Q2/Career%20Length%20by%20Defensive%20Tier.png" class="img-fluid" alt="Career Length by Defensive Tier"> Next, we created a boxplot to compare career length between defensive tiers. Specifically, we focused on the top 25% of defenders. The boxplot shows that players in this elite defensive tier tend to have longer careers with several reaching exceptional longevity (up to 22 seasons). This supports the hypothesis that better defenders tend to enjoy more stable careers.</p>
<p><img src="pic/Q2/Median%20Defensive%20Rating%20by%20Era.png" class="img-fluid" alt="Median Defensive Rating by Era"> Finally, in order to solve the time deviation, we studied the changes of the median of the defense level in different periods. We observed that the defensive score value has a significant upward trend over time, which confirms that we need to consider the era effect.</p>
<p>By combining dot plot, hierarchical comparison and vertical analysis, we provide a multi-angle approach to evaluate the relationship between defense level and professional length. The results show that although defense is not the only factor determining the length of a career, it is an important positive correlation factor.</p>
</section>
<section id="limitation-1" class="level3">
<h3 class="anchored" data-anchor-id="limitation-1">Limitation</h3>
<p>Although our analysis reveals the potential connection between defensive ability and career lifespan, we must admit some limitations. First, the defensive level will be influenced by factors such as the team’s performance, the pace of the game, and the defensive plan. It may not fully reflect a person’s true defensive contribution, especially for the players of teams with weak defense.</p>
<p>Secondly, career lifespan is influenced by many external factors, not just performance, such as injury history, team needs, player roles, and even off-field behavior. Our model does not control for these confounding variables, which may blur or exaggerate the observed patterns.</p>
</section>
</section>
<section id="question-3-how-can-traditional-centers-complete-their-transformation-in-the-small-ball-era" class="level2">
<h2 class="anchored" data-anchor-id="question-3-how-can-traditional-centers-complete-their-transformation-in-the-small-ball-era">Question 3: How can traditional centers complete their transformation in the “small-ball era”?</h2>
<section id="justification-of-approach-2" class="level3">
<h3 class="anchored" data-anchor-id="justification-of-approach-2">Justification of approach</h3>
</section>
<section id="evolution-of-bigs-over-decades." class="level3">
<h3 class="anchored" data-anchor-id="evolution-of-bigs-over-decades.">Evolution of Bigs Over Decades.</h3>
<p><img src="pic/Q3/Evolution%20of%203-Point%20Attempts%20Among%20Big%20Men.png" class="img-fluid" alt="Evolution of 3-Point Attempts Among Big Men"> Question 3 analyzed the evolution of three-point shooting by NBA big men (centers and power forwards) from the early 1980s to the present. We investigated how outside shooting has shifted from being rare to a demand of frontcourt players, reflecting the broader strategic evolution of basketball.</p>
<p>First, we drew a line graph showing the number of three-point attempts made by centers and power forwards each season, observing the evolution trends of the two from the perspective of time. As can be seen from the chart, the number of three-point attempts by centers has significantly increased since the mid-2010s. This trend supports the narrative of position mobility and creating space across the entire league.</p>
<p><img src="pic/Q3/%20Decade-by-Decade%20Comparison.png" class="img-fluid" alt="Decade-by-Decade Comparison"> Subsequently, we grouped the data by year and drew a bar chart for the four periods from the 1990s to the 2020s, showing players’ average number of three-point attempts at different positions. This approach helps to eliminate the impact of annual fluctuations and determine from the overall trend whether the center is gradually approaching the main power forward for outside shooting. It can be seen from the chart that centers have significantly increased their three-point attempts since the late 2010s, narrowing the gap with power forwards.</p>
<p><img src="pic/Q3/Big%20Men’s%20Share%20of%20Total%20League%203PA.png" class="img-fluid" alt="Big Men’s Share of Total League 3PA"> Finally, we also drew a line chart to show the changes in the proportion of big men (at the three position and above) among all the three-point shooters in the league. From a macro perspective, this chart reflects that the overall participation of centers and power forwards in perimeter tactics is constantly increasing, indicating that the transformation of centers is not only an individual behavior but also a manifestation of the evolution of the entire league’s tactics.</p>
</section>
<section id="limitation-2" class="level3">
<h3 class="anchored" data-anchor-id="limitation-2">Limitation</h3>
<p>Although this section presents the changing trends of center three-point shooting in the small-ball era from multiple perspectives, the following limitations remain. The first issue is the ambiguity of position definitions. We use a player’s registered position to divide “center” and “power forward”. However, position mobility has increased in modern basketball, and many players’ actual responsibilities in the game have exceeded the traditional definitions. A “center” may take more outside shots in an offensive play, while a “power forward” may frequently engage in low-post duels. Therefore, position classification cannot fully reflect the proper tactical roles of players. The second is the incomprehensiveness of the indicator selection. We use “3PA per Game” to measure the centers’ transformation degree. Still, this indicator fails to cover more comprehensive performances such as three-point shooting percentage, shooting efficiency, or tactical position. Although some centers have attempted more three-pointers, their shooting percentage is low, which may instead weaken the team’s offensive efficiency.</p>
<p>In conclusion, although the data trends provide supportive evidence for the “center-forward transition”, more refined variable design, stricter causal identification methods, and supplementary verification combined with qualitative tactical analysis are still needed to fully understand this phenomenon.</p>
</section>
</section>
<section id="question-4do-high-utilization-players-truly-demonstrate-the-salary-returns-they-deserve" class="level2">
<h2 class="anchored" data-anchor-id="question-4do-high-utilization-players-truly-demonstrate-the-salary-returns-they-deserve">Question 4:Do high-utilization players truly demonstrate the salary returns they deserve?</h2>
<section id="justification-of-approach-3" class="level3">
<h3 class="anchored" data-anchor-id="justification-of-approach-3">Justification of approach</h3>
</section>
<section id="nba-player-salary-vs.-performance-metrics" class="level3">
<h3 class="anchored" data-anchor-id="nba-player-salary-vs.-performance-metrics">NBA Player Salary vs.&nbsp;Performance Metrics</h3>
<p><img src="pic/Q4/Salary-Usage%20Rate.png" class="img-fluid" alt="Salary vs.&nbsp;Usage Rate (Interactive)"> We construct an analytical perspective from three dimensions to explore whether players with high utilization rates have received reasonable salary returns. First, we drew a scatter plot between the player Usage Rate and salary, visually presenting the relationship between the usage frequency and the salary level. The chart shows that although the salary distribution of players with high usage rates shows a slight upward trend, the overall dispersion is relatively large, and there are a large number of players with high usage rates but low salaries.</p>
<p><img src="pic/Q4/Salary-PIE.png" class="img-fluid" alt="Salary vs.&nbsp;Player Impact Estimate (PIE) – Interactive"> Secondly, we introduced the comprehensive performance indicator PIE (Player Impact Estimate) and compared it with the salary to further determine whether the players’ actual influence matches their income. This graph shows a certain degree of positive correlation, indicating that some outstanding players have indeed earned higher incomes, but there are still many high-PIE players whose salaries have not reached the expected level.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="pic/Q4/Usage-Salary-Team-Win.png" class="img-fluid figure-img"></p>
<figcaption>Usage and Salary vs.&nbsp;Team Win %</figcaption>
</figure>
</div>
<p>Finally, to evaluate the actual impact of these high-usage players on the team’s performance, we take the Usage Rate and salary as the horizontal axis, color mapping, and the vertical axis as the team’s playoff winning rate. This graph helps us identify whether high usage and salaries can translate into winning rate advantages. The results show that the distribution of players with high usage rates is relatively wide, and the improvement in winning rates is not significant. This suggests that we cannot simply define “high returns” by the proportion of shot attempts or high salaries.</p>
<p>Through this triple visualization design, we cross-verified from multiple perspectives, such as “usage” and “performance,” to “team effectiveness,” comprehensively evaluating the relationship between usage rate and salary return and avoiding the bias caused by single-dimensional analysis.</p>
</section>
<section id="limitation-3" class="level3">
<h3 class="anchored" data-anchor-id="limitation-3">Limitation</h3>
<p>Although this part uses key indicators such as Usage Rate and PIE, and combines the team’s playoff winning rate to evaluate the relationship between player usage rate and salary return, there are still some limiting factors in the analysis. First of all, the Usage Rate only measures the player’s shooting and ball-handling participation on the offensive end. It cannot fully reflect their contribution, especially the critical influence on the game, which results in defense and off-the-ball movement.</p>
<p>Secondly, although the PIE indicator can reflect players’ influence on the game to a certain extent, it is still limited by its calculation method and may be biased towards players with high playing time. The correlation analysis between salary and winning rate did not take into account complex factors such as coaching strategies, lineup combinations, injuries, and the depth of substitutes. Therefore, asserting that a high usage rate definitely brings high cost-effectiveness is difficult.</p>
<p>In addition, when processing data, some extreme values (such as players with extremely high salaries but average performance) may pull the overall trend. In subsequent analyses, robust indicators such as regression residuals or medians can be further used to improve accuracy.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>